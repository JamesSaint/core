<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#003366" />
  <title>Journal - James Saint</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Collected writings in /core by James Saint, newest first." />

  <!-- Fonts + Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
  <link href="https://jamessaint.github.io/medical/global_styles.css" rel="stylesheet" />
</head>
<body>
<main class="content">
  <header class="mb-3">

    <h1>Journal</h1>
    
  </header>

  <section id="latest" class="card-like">
    <h2>Entries</h2>
    <div class="table-responsive">
      <table id="core-table">
        <thead>
          <tr>
            <th style="width:10rem;">Date</th>
            <th>Title</th>
          </tr>
        </thead>
        <tbody id="core-body">
          <tr id="loading-row"><td colspan="2"><span class="spinner">Loading…</span></td></tr>
        </tbody>
      </table>
    </div>
  </section>

            <!-- Footer -->
            <footer class="site-footer mt-4" role="contentinfo" aria-label="Site footer">
                <div class="footer-container text-center">
                    <hr class="footer-rule" />
                    <div class="footer-note mb-1">
                        Private & Confidential.
                    </div>
                    <div class="footer-copy">
                        © <span id="copy-year"></span> James Saint. All rights reserved.
                    </div>
                </div>
            </footer>
            <!-- Year Autoupdate -->
            <script>
            (function() {
                var y = new Date().getFullYear();
                var el = document.getElementById('copy-year');
                if (el) el.textContent = y;
            })();
            </script>

  <script>
    async function fetchText(url) {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.text();
    }

    function dateFromFilename(url) {
      // Accept 2025-10-26 or 26-10-2025 or with underscores
      const name = url.split("/").pop();
      let m = name.match(/(20\\d{2})[-_](\\d{2})[-_](\\d{2})/);
      if (m) return new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
      m = name.match(/(\\d{2})[-_](\\d{2})[-_](20\\d{2})/);
      if (m) return new Date(Date.UTC(+m[3], +m[2]-1, +m[1]));
      return null;
    }

    function isoDate(d) {
      return d.toISOString().slice(0,10);
    }

    async function titleFromPage(url) {
      try {
        const html = await fetchText(url);
        const doc = new DOMParser().parseFromString(html, "text/html");
        const h1 = doc.querySelector("h1");
        const title = doc.querySelector("title");
        let t = (h1 && h1.textContent.trim()) || (title && title.textContent.trim()) || url.split("/").pop().replace(/[-_]/g, " ");
        return t.replace(/\\s+/g, " ");
      } catch {
        return url.split("/").pop().replace(/[-_]/g, " ");
      }
    }

    async function buildCoreIndex() {
      const tbody = document.getElementById("core-body");
      const loading = document.getElementById("loading-row");
      try {
        const xmlText = await fetchText("/sitemap.xml");
        const xml = new DOMParser().parseFromString(xmlText, "application/xml");
        const urls = Array.from(xml.querySelectorAll("url")).map(u => ({
          loc: u.querySelector("loc")?.textContent?.trim() || "",
          lastmod: u.querySelector("lastmod")?.textContent?.trim() || ""
        }));

        // Filter to /core/ html pages excluding index.html
        let core = urls.filter(u =>
          u.loc.includes("/core/") &&
          u.loc.endsWith(".html") &&
          !/\\/(index|Index)\\.html$/.test(u.loc)
        );

        // Build entries with dates and titles
        const entries = await Promise.all(core.map(async u => {
          const fileDate = dateFromFilename(u.loc);
          const lastMod = u.lastmod ? new Date(u.lastmod) : null;
          const dt = fileDate || lastMod || new Date(0);
          const displayDate = isNaN(dt) ? "" : isoDate(dt);
          const title = await titleFromPage(u.loc);
          return { url: u.loc, title, dt, displayDate };
        }));

        // Sort newest first
        entries.sort((a, b) => b.dt - a.dt);

        // Render
        tbody.innerHTML = entries.map(e => `
          <tr>
            <td class="date">${e.displayDate}</td>
            <td class="title"><a href="${e.url}">${e.title}</a></td>
          </tr>
        `).join("") || `<tr><td colspan="2">No entries found.</td></tr>`;
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="2">Could not build index. ${String(err.message || err)}</td></tr>`;
      } finally {
        if (loading) loading.remove();
      }
    }

    buildCoreIndex();
  </script>
</main>
</body>
</html>
